# =============================================================================
# RAG Development Docker Compose
# =============================================================================
# Full development environment with hot-reload for all services
#
# Usage:
#   make dev      - Start all services
#   make down     - Stop all services
#   make logs     - View logs
#
# Or directly:
#   docker compose -f docker-compose.dev.yml up
# =============================================================================

services:
  # ===========================================================================
  # Infrastructure Services
  # ===========================================================================
  
  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - qdrant_storage:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_storage:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  mongodb:
    image: mongo:7
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin123
      - MONGO_INITDB_DATABASE=rag_db
    volumes:
      - mongodb_storage:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # Backend Services
  # ===========================================================================

  api:
    build:
      context: .
      dockerfile: docker/api.Dockerfile
    restart: unless-stopped
    ports:
      - "8000:8000"
    depends_on:
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      - NODE_ENV=development
      - PORT=8000
      - QDRANT_URL=http://qdrant:6333
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/rag_db?authSource=admin
      # OpenAI Configuration for Embeddings and Chat (from .env file)
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      # OpenAI Models - Task-specific (using best models per task)
      - OPENAI_CHAT_MODEL=${OPENAI_CHAT_MODEL:-gpt-4o}
      - OPENAI_QUERY_ANALYSIS_MODEL=${OPENAI_QUERY_ANALYSIS_MODEL:-gpt-4o}
      - OPENAI_RERANK_MODEL=${OPENAI_RERANK_MODEL:-gpt-4o}
      - OPENAI_CONTEXT_ANALYSIS_MODEL=${OPENAI_CONTEXT_ANALYSIS_MODEL:-gpt-4o-mini}
      - OPENAI_FOLLOWUP_MODEL=${OPENAI_FOLLOWUP_MODEL:-gpt-4o}
      # Gemini Configuration (optional, from .env file)
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_EMBEDDING_MODEL=${GEMINI_EMBEDDING_MODEL:-text-embedding-004}
      - GEMINI_CHAT_MODEL=${GEMINI_CHAT_MODEL:-gemini-1.5-pro}
      # Hot-reload for macOS Docker
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    volumes:
      - ./api/src:/app/api/src
      - ./api/test:/app/api/test
      - ./packages:/app/packages
      # Preserve the built text-utils dist folder (built in Dockerfile, would be overwritten by host mount)
      - /app/packages/text-utils/dist
      - ./data:/app/data
      - api_node_modules:/app/node_modules
      - api_pkg_node_modules:/app/api/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  landing-page-api:
    build:
      context: .
      dockerfile: docker/landing-page-api.Dockerfile
    restart: unless-stopped
    ports:
      - "8001:8001"
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      - NODE_ENV=development
      - PORT=8001
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/landing_db?authSource=admin
      # Allow CORS from the landing page frontend
      - CORS_ORIGIN=http://localhost:3001,http://localhost:5173
      # Hot-reload for macOS Docker
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    volumes:
      - ./apps/landing-page-api/src:/app/src
      - landing_api_node_modules:/app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # ===========================================================================
  # Frontend Services
  # ===========================================================================

  company-portal:
    build:
      context: .
      dockerfile: docker/company-portal.Dockerfile
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - api
    environment:
      - NODE_ENV=development
      # Use localhost since API calls are made from the browser, not from within Docker
      - VITE_API_URL=http://localhost:8000
      # Hot-reload for macOS Docker
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    volumes:
      - ./apps/company-portal/src:/app/src
      - ./apps/company-portal/index.html:/app/index.html
      - ./packages:/app/packages
      - company_portal_node_modules:/app/node_modules

  landing-page:
    build:
      context: .
      dockerfile: docker/landing-page.Dockerfile
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      # Use localhost since API calls are made from the browser, not from within Docker
      - VITE_API_URL=http://localhost:8001
      # Hot-reload for macOS Docker
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    volumes:
      - ./apps/landing-page/src:/app/src
      - ./apps/landing-page/index.html:/app/index.html
      - ./packages:/app/packages
      - landing_page_node_modules:/app/node_modules

# =============================================================================
# Volumes
# =============================================================================

volumes:
  qdrant_storage:
  redis_storage:
  mongodb_storage:
  api_node_modules:
  api_pkg_node_modules:
  landing_api_node_modules:
  company_portal_node_modules:
  landing_page_node_modules:

