name: CI

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'feature/**'
      - 'feat/**'
      - 'fix/**'
      - 'cursor/**'
      - 'hotfix/**'
      - 'release/**'
  pull_request:
    branches: [main, master, develop]

# Cancel redundant runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # API: Lint, Format, Unit Tests with Coverage
  # ============================================
  api-checks:
    name: API - Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install dependencies
        working-directory: ./api
        run: npm ci

      - name: Run linter
        working-directory: ./api
        run: npm run lint

      - name: Check code formatting
        working-directory: ./api
        run: npm run format:check

      - name: Run unit tests with coverage
        working-directory: ./api
        run: npm run test:coverage:ci
        env:
          NODE_ENV: test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./api/coverage/lcov.info
          flags: api-unittests
          name: api-coverage
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-coverage-report
          path: api/coverage/
          retention-days: 14

      - name: Coverage Summary
        working-directory: ./api
        run: |
          echo "## ðŸ“Š API Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
            echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% |" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # API: Build Verification
  # ============================================
  api-build:
    name: API - Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install dependencies
        working-directory: ./api
        run: npm ci

      - name: Build TypeScript
        working-directory: ./api
        run: npm run build

  # ============================================
  # Frontend Apps: Lint, Typecheck, Build
  # ============================================
  frontend-checks:
    name: Frontend - ${{ matrix.app }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: [company-portal, landing-page]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # Version is read from packageManager in package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint ${{ matrix.app }}
        run: pnpm --filter @rag/${{ matrix.app }} lint
        continue-on-error: true

      - name: Typecheck ${{ matrix.app }}
        run: pnpm --filter @rag/${{ matrix.app }} typecheck

      - name: Build ${{ matrix.app }}
        run: pnpm --filter @rag/${{ matrix.app }} build

  # ============================================
  # Python Embed Service: Lint & Type Check
  # ============================================
  python-checks:
    name: Python - Embed Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./embed
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: embed/requirements*.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Lint with ruff
        run: ruff check . --output-format=github
        continue-on-error: true

      - name: Type check with mypy
        run: mypy app.py --ignore-missing-imports

  # ============================================
  # Docker Build Verification
  # ============================================
  docker-build:
    name: Docker - ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [api, embed]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }} Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: false
          tags: ${{ matrix.service }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Security: Dependency Audit
  # ============================================
  security-audit:
    name: Security - Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Audit API dependencies
        working-directory: ./api
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Security Summary
        run: |
          echo "## ðŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dependency audit completed. Check the logs for details." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Coverage Check (Required for PRs)
  # ============================================
  coverage-check:
    name: Coverage - Threshold Check
    runs-on: ubuntu-latest
    needs: api-checks
    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-coverage-report
          path: coverage/

      - name: Check coverage thresholds
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
            
            # Thresholds - adjust these as coverage improves
            LINE_THRESHOLD=40
            STATEMENT_THRESHOLD=40
            FUNCTION_THRESHOLD=40
            BRANCH_THRESHOLD=35
            
            echo "## ðŸ“ˆ Coverage Threshold Check" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Current | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            
            FAILED=0
            
            if (( $(echo "$LINES >= $LINE_THRESHOLD" | bc -l) )); then
              echo "| Lines | ${LINES}% | ${LINE_THRESHOLD}% | âœ… |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Lines | ${LINES}% | ${LINE_THRESHOLD}% | âŒ |" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
            
            if (( $(echo "$STATEMENTS >= $STATEMENT_THRESHOLD" | bc -l) )); then
              echo "| Statements | ${STATEMENTS}% | ${STATEMENT_THRESHOLD}% | âœ… |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Statements | ${STATEMENTS}% | ${STATEMENT_THRESHOLD}% | âŒ |" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
            
            if (( $(echo "$FUNCTIONS >= $FUNCTION_THRESHOLD" | bc -l) )); then
              echo "| Functions | ${FUNCTIONS}% | ${FUNCTION_THRESHOLD}% | âœ… |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Functions | ${FUNCTIONS}% | ${FUNCTION_THRESHOLD}% | âŒ |" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
            
            if (( $(echo "$BRANCHES >= $BRANCH_THRESHOLD" | bc -l) )); then
              echo "| Branches | ${BRANCHES}% | ${BRANCH_THRESHOLD}% | âœ… |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Branches | ${BRANCHES}% | ${BRANCH_THRESHOLD}% | âŒ |" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ $FAILED -eq 1 ]; then
              echo "âŒ **Coverage thresholds not met!**" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âœ… **All coverage thresholds met!**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Coverage summary not found" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Integration Tests (On-demand with label)
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'run-integration')
    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin123
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install dependencies
        working-directory: ./api
        run: npm ci

      - name: Wait for services
        run: |
          echo "Waiting for MongoDB..."
          timeout 30 bash -c 'until nc -z localhost 27017; do sleep 1; done'
          echo "Waiting for Redis..."
          timeout 30 bash -c 'until nc -z localhost 6379; do sleep 1; done'
          echo "Waiting for Qdrant..."
          timeout 30 bash -c 'until nc -z localhost 6333; do sleep 1; done'
          echo "All services ready!"

      - name: Run integration tests
        working-directory: ./api
        run: npm run test:integration
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://admin:admin123@localhost:27017/rag_test?authSource=admin
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          QDRANT_URL: http://localhost:6333

  # ============================================
  # CI Status Summary
  # ============================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [api-checks, api-build, frontend-checks, python-checks, docker-build, security-audit, coverage-check]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "## ðŸš€ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Checks | ${{ needs.api-checks.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Build | ${{ needs.api-build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend-checks.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ needs.python-checks.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker-build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-audit.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage-check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.api-checks.result }}" != "success" ] || \
             [ "${{ needs.api-build.result }}" != "success" ] || \
             [ "${{ needs.coverage-check.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Critical checks failed!**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
